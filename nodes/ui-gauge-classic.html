<script type="text/javascript">
    RED.nodes.registerType('ui-gauge-classic', {
        category: RED._('@flowfuse/node-red-dashboard/ui-base:ui-base.label.category'),
        color: RED._('@flowfuse/node-red-dashboard/ui-base:ui-base.colors.dark'),
        defaults: {
            name: { value: "" },
            group: { type: 'ui-group', required: true },
            order: { value: 0 },
            width: {
                value: 0,
                validate: function (v) {
                    const width = v || 0
                    const currentGroup = $('#node-input-group').val() || this.group
                    const groupNode = RED.nodes.node(currentGroup)
                    const valid = !groupNode || +width <= +groupNode.width
                    $('#node-input-size').toggleClass('input-error', !valid)
                    return valid
                }
            },
            height: { value: 0 },
            min: { 
                value: 0, 
                required: true,
                validate:function(v) {
                    // must be a number and not the same as max
                    const max=Number($("#node-input-max").length ? $("#node-input-max").val() : this.max)
                    return (RED.validators.number()(v) && Number(v) !== max)
                },
            },
            max: { 
                value: 10,
                validate:function(v) {
                    // must be a number and not the same as min
                    const min=Number($("#node-input-min").length ? $("#node-input-min").val() : this.min)
                    return (RED.validators.number()(v) && Number(v) !== min)
                },
            },
            sectors: {
                value: [],
                validate:function(sectors) {
                    //console.log(`validate sectors: ${JSON.stringify(sectors)}`)
                    // Each start value must be a number and they must be increasing in value
                    let isValid = true
                    sectors.forEach((sector,index) => {
                        isValid = isValid && RED.validators.number()(sector.start)
                        // if not first one then should be greater than previous
                        if (index>0) {
                            isValid = isValid && sector.start > sectors[index-1].start
                        }
                    })
                    return isValid
                },
            },
            major_division: {
                value: 1,
                validate:function(v) {
                    // must be a number >0
                    return (RED.validators.number()(v) && Number(v) > 0)
                },
            },
            minor_division: {
                value: 0.2,
                validate:function(v) {
                    // must be a number >0
                    return (RED.validators.number()(v) && Number(v) > 0)
                },
            },
            value_decimal_places: {
                value: 1,
                validate:function(v) {
                    // must be a number >=0
                    return (RED.validators.number()(v) && Number(v) >= 0)
                },
            },
            scale_decimal_places: {
                value: 0,
                validate:function(v) {
                    // must be a number >=0
                    return (RED.validators.number()(v) && Number(v) >= 0)
                },
            },
            label: {value: ""},
            measurement: {value: ""},
            units: {value: "Â°C"},
            needles: {
                value: [
                    {"color":"black","lengthPercent":"100", "topic":"",}
                ],
                validate:function(needles) {
                    //console.log(`validate needles: ${JSON.stringify(needles)}`)
                    // Each length must be a +ve number and topic must be present unless only one needle
                    let isValid = true
                    needles.forEach((needle) => {
                        isValid &&= (RED.validators.number()(needle.lengthPercent) && Number(needle.lengthPercent) > 0)
                        // if more than one needle then all must have topics
                        if (needles.length > 1) {
                            // checks for non-empty topic
                            isValid &&= needle.topic.trim().length > 0
                        }
                    })
                    return isValid
                },
            },
            sweep_angle: {
                value: 250,
                validate:function(v) {
                    // must be a number >0 and <360.
                    const num = Number(v)
                    return (RED.validators.number()(v) && num > 0 && num < 360)
                },
            },
            myclass: {value: ""},
        },
        inputs: 1,
        outputs: 0,
        icon: "font-awesome/fa-dashboard",  // "fa-dashboard",
        paletteLabel: "gauge glassic",
        label: function() {
            return this.name || "gauge classic";
        },
        oneditprepare: function () {
            var node = this
            $('#node-input-size').elementSizer({
                width: '#node-input-width',
                height: '#node-input-height',
                group: '#node-input-group'
            });

            let sectorsList = $("#node-input-sectors-container")
            sectorsList.editableList({
                addItem: function(container, i, sector) {
                    //console.log(`Adding: ${JSON.stringify(sector)}`)
                    let newAddition = false   // whether this is as a result of Add button being hit
                    if (!sector.hasOwnProperty("start")) {
                        // this is a new needle
                        newAddition = true
                        sector = {start: "", color: ""}
                        if (i === 0) {
                            sector.start = Math.min(Number($("#node-input-min").val()), Number($("#node-input-max").val())) || "0"
                        }
                    }
                    let row =  $('<div/>', {
                        class: 'form-row',
                        style: 'display: flex; margin-bottom: 0;'
                    }).appendTo(container)

                    // Add the sector start field
                    let startField = $('<input/>', {
                        type: 'text',
                        name: i,    // save the index in the name field so we can identify the field later
                        required: true,
                        style: 'margin-left: 5px; margin-bottom: 0;',
                        class: 'node-input-sector-start-value'
                    }).appendTo(row)
                    startField.val(sector.start)

                    // watch for changes on the start field
                    startField.on("change keyup paste", function() {
                        // pick up the new value and index
                        const startValue = this.value;
                        const thisIndex = Number(this.name)
                        //console.log(`startval: ${startValue}, index: ${thisIndex}`)

                        // Validate the value
                        let valid = true
                        // check it is a number
                        if (!RED.validators.number()(startValue)) {
                            //console.log(`not number`)
                            valid = false
                        } else {
                            // Find all start input fields
                            let values = []
                            sectorsList.find(".node-input-sector-start-value").each(function() {
                                values.push(Number(this.value))
                            })
                            //console.log(`values: ${JSON.stringify(values)}`)
                            // if it is not the first one then the value should be greater than the previous
                            if (thisIndex > 0  &&  Number(this.value) <= values[thisIndex-1]) {
                                valid = false
                            } else {
                                // if this is not the last one then it should be less than the next one
                                if (thisIndex < values.length-1  &&  Number(startValue) >= values[thisIndex+1])
                                {
                                    valid = false
                                }
                            }
                        }

                        // Show a red border around the field, when not valid
                        if (!valid) {
                            $(this).css('border', '1px solid rgb(214, 97, 95)');
                        }
                        else {
                            $(this).css('border', '');
                        }
                    });

                    // Add the sector color field
                    let colorField = $('<input/>', {
                        type: 'text',
                        style: 'margin-left: 5px; margin-bottom: 0;',
                        class: 'node-input-sector-color-value'
                    }).appendTo(row)
                    colorField.val(sector.color)

                    // if this is a new row then validate everything
                    if (newAddition) {

                    }
                },

                sortable: true,
                removable: true,
                height: 'auto',
                scrollOnAdd: true,
                header: $('<div>').append(
                    $.parseHTML(
                        "<div style='width:40%; margin-left:10%; display:inline-grid;'>Start</div><div style='width:30%; display:inline-grid;'>Colour</div>"
                    )
                ),

                addButton: 'add sector'
            })
            this.sectors = this.sectors || []
            //console.log(`About to add items: ${JSON.stringify(this.sectors)}`)
            sectorsList.editableList('addItems', this.sectors)

            let needlesList = $("#node-input-needles-container")
            needlesList.editableList({
                addItem: function(container, i, needle) {
                    let newAddition = false   // whether this is as a result of Add button being hit
                    if (!needle.hasOwnProperty("topic")) {
                        newAddition = true
                        needle = {color: "", lengthPercent: 100, topic: "", }
                    }
                    let row =  $('<div/>', {
                        class: 'form-row',
                        style: 'display: flex; margin-bottom: 0;'
                    }).appendTo(container)

                    let colorField = $('<input/>', {
                        type: 'text',
                        style: 'margin-left: 5px; margin-bottom: 0;',
                        class: 'node-input-needle-color-value'
                    }).appendTo(row)
                    colorField.val(needle.color)

                    let lengthField = $('<input/>', {
                        type: 'text',
                        style: 'margin-left: 5px; margin-bottom: 0;',
                        class: 'node-input-needle-length-value'
                    }).appendTo(row)
                    lengthField.val(needle.lengthPercent)
                    // watch for changes on the length field
                    lengthField.on("change keyup paste", function() {
                        // validate this length field
                        validateLengthField(this)
                    });

                    let topicField = $('<input/>', {
                        type: 'text',
                        style: 'margin-left: 5px; margin-bottom: 0;',
                        class: 'node-input-needle-topic-value'
                    }).appendTo(row)
                    topicField.val(needle.topic)
                    // watch for changes on the topic field
                    topicField.on("change keyup paste", function() {
                        // have to validate the full set of topics so just do everything
                        validateNeedles(needlesList)
                    });

                    if (newAddition) {
                        // this is a new row being added so validate the set - shouldn't need to do this as it should be handled by resize
                        validateNeedles(needlesList)
                    }

                },

                sortable: true,
                removable: true,
                height: 'auto',
                scrollOnAdd: true,
                header: $('<div>').append(
                    $.parseHTML(
                        "<div style='width:30%; margin-left:10%; display:inline-grid;'>Colour</div><div style='width:30%; display:inline-grid;'>Length %</div><div style='width:10%; display:inline-grid;'>Topic</div>"
                    )
                ),

                addButton: 'add needle',

                resize: function() {
                    // called when number of rows is changed - but it doesn't seem to work properly
                    console.log("Needles list resize")
                    validateNeedles(needlesList)
                },

                removeItem: function(data) {
                    // called when an item is deleted - shouldn't need to do this as it should be handled by resize
                    validateNeedles(needlesList)
                },
            })

            this.needles = this.needles || []
            //console.log(`About to add items: ${JSON.stringify(this.needles)}`)
            needlesList.editableList('addItems', this.needles)
            // show red boxes for any invalid fields
            validateNeedles(needlesList)
        },
        oneditsave: function() {
            let sectors = $("#node-input-sectors-container").editableList('items');
            var node = this;
            node.sectors = [];
            sectors.each(function(i) {
                node.sectors.push({
                    start: $(this).find('.node-input-sector-start-value').val(),
                    color: $(this).find('.node-input-sector-color-value').val()
                })
            });
            //console.log(`oneditsave sectors: ${JSON.stringify(node.sectors)}`)

            let needles = $("#node-input-needles-container").editableList('items');
            var node = this;
            node.needles = [];
            needles.each(function(i) {
                node.needles.push({
                    topic: $(this).find('.node-input-needle-topic-value').val(),
                    color: $(this).find('.node-input-needle-color-value').val(),
                    lengthPercent: $(this).find('.node-input-needle-length-value').val()
                })
            });
            //console.log(`oneditsave needles: ${JSON.stringify(node.needles)}`)
        },
    })

    function validateNeedles(needlesList) {
        // given the needles list validates all fields, drawing red boxes as appropriate
        // Find all length input fields
        let lengths = []
        needlesList.find(".node-input-needle-length-value").each(function() {
            validateLengthField(this)
        })

        // Find all topic input fields
        let topics = []
        const topicFields = needlesList.find(".node-input-needle-topic-value")
        const fieldCount = topicFields.length
        topicFields.each(function() {
            validateTopicField(this, fieldCount)
        })
    }

    function validateLengthField(lengthField) {
        const lengthValue = lengthField.value
        //console.log(`validateLengthField ${lengthValue}`)
        let valid = RED.validators.number()(lengthValue) && Number(lengthValue) > 0
        //console.log(`valid: ${valid}`)

        // Show a red border around the field, when not valid
        if (!valid) {
            $(lengthField).css('border', '1px solid rgb(214, 97, 95)');
        }
        else {
            $(lengthField).css('border', '');
        }
    }
    function validateTopicField(topicField, fieldCount) {
        const topicValue = topicField.value
        // topic must not be empty if more than one needle
        let valid = fieldCount === 1  ||  topicValue.trim().length > 0

        // Show a red border around the field, when not valid
        if (!valid) {
            $(topicField).css('border', '1px solid rgb(214, 97, 95)');
        }
        else {
            $(topicField).css('border', '');
        }
    }
</script>

<script type="text/html" data-template-name="ui-gauge-classic">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> <span data-i18n="ui-gauge-classic.label.size"></label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-min"><i class="fa fa-hand"></i>Range:</label>
        <span for="node-input-min">Min</span>
        <input type="text" id="node-input-min" style="width:80px; margin-left:10px;">
        <span for="node-input-max" style="margin-left:30px;">Max</label>
        <input type="text" id="node-input-max" style="width:80px; margin-left:10px;">
    </div>
    <div class="form-row">
        <label for="node-input-sweep_angle"><i class="fa fa-hand"></i>Sweep Angle (deg)</label>
        <input type="text" id="node-input-sweep_angle">
    </div>
    <div class="form-row node-input-sectors-container-row">
      <label><i class="fa fa-list"></i> Sectors</label>
      <ol id="node-input-sectors-container"></ol>
    </div>
    <div class="form-row node-input-needles-container-row">
      <label><i class="fa fa-list"></i>Needles</label>
      <ol id="node-input-needles-container"></ol>
    </div>
     <div class="form-row">
        <label for="node-input-major_divison"><i class="fa fa-hand"></i>Divisions:</label>
        <span for="node-input-major_divison">Major</span>
        <input type="text" id="node-input-major_division" style="width:80px; margin-left:10px;">
        <span for="node-input-minor_divison" style="margin-left:30px;">Minor</label>
        <input type="text" id="node-input-minor_division" style="width:80px; margin-left:10px;">
    </div>
    <div class="form-row">
        <label for="node-input-value_decimal_places"><i class="fa fa-hand"></i>Decimal Places:</label>
        <span for="node-input-value_decimal_places">Value</span>
        <input type="text" id="node-input-value_decimal_places" style="width:80px; margin-left:10px;">
        <span for="node-input-scale_decimal_places" style="margin-left:30px;">Scale</label>
        <input type="text" id="node-input-scale_decimal_places" style="width:80px; margin-left:10px;">
    </div>
    <div class="form-row">
        <label for="node-input-units"><i class="fa fa-hand"></i>Units</label>
        <input type="text" id="node-input-units">
    </div>
    <div class="form-row">
        <label for="node-input-label"><i class="fa fa-hand"></i>Label</label>
        <input type="text" id="node-input-label">
    </div>
    <div class="form-row">
        <label for="node-input-measurement"><i class="fa fa-hand"></i>Measurement</label>
        <input type="text" id="node-input-measurement">
    </div>
    <div class="form-row">
        <label for="node-input-myclass"><i class="fa fa-hand"></i>Class</label>
        <input type="text" id="node-input-myclass">
    </div>
</script>